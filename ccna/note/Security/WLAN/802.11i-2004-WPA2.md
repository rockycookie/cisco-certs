# WPA2 - IEEE 802.11i-2004
It was later incorporated into the published IEEE 802.11-2007 standard.

Reference:
- https://www.wifi-professionals.com/2019/01/4-way-handshake#:~:text=In%20case%20of%20WPA2%2FPSK,used%20for%20unicast%20data%20encryption.

## New protocols:
- 4-way handshake
- group key handshake
for key management

confidentiality and integrity protocols
- TKIP
    - to run on devices that support WEP
- CCMP

## Initial authentication process
1. PSK or EAP-exchange to ensure that the client station (STA) is authenticated with the access point (AP)
    - pre-hared key
    - EAP-exchange through 802.1X (known as EAPOL, which requires the presence of an auth server)
2. A shared secret key is generated
    - called PMK (Pairwise Master Key)
        - for PSK, PSK is the PMK
        - for EAP, PMK is derived from the EAP parameters from the auth server

## PMK
- PMK is used to decrypt messages
- The PMK is designed to last the entire session and should be exposed as little as possible
- Successful message decryption indicates the knowledge of the PMK

## 4-way handshake
A device going through states from authentication to association. Once the device is authenticated and associated and now security will be checked, and 4-way handshake will start. <br/>
Instead of sending the password to the access points there are EAPOL (Extensible authentication protocol over LAN) messages exchange happens. <br/>
A four-way handshake is used to 
- establish PTK (Pairwise Transient Key)
    - The PTK is generated by concatenating the following attributes: PMK, AP nonce (ANonce), STA nonce (SNonce), AP MAC address, and STA MAC address
    - PTK is used to encrypt all unicast traffic between a client station and the access point
    - PTK is unique between a client station and access point
    - PTK is dependent on another high-level key PMK
- yield GTK (Group Temporal Key)
    - to encrypt/decrypt multicast and broadcast traffic
    - shared between all client devices associated with 1 access point

All messages are sent as EAPOL-Key frames; <br/>
In WPA2/PSK, when a device authenticates with an access point, the PSK becomes the PMK

The flow:
1. AP sends a nonce-value (ANonce) to STA together with a Key Replay Counter
    - Key Replay Counter is a number that is used to match each pair of messages sent, and discard replayed messages
    - the STA now has all the attributes to construct the PTK
2. STA sends its own nonce-value (SNonce) to AP together with 
    - Message Integrity Code (MIC)
        - which is a Message Authentication and Integrity Code (MAIC)
    - Key Replay Counter
3. The AP verifies Message 2
    - by checking MIC, RSN, ANonce and Key Replay Counter Field
    - and if valid constructs and sends the GTK with another MIC
4. STA verifies Message 3
    - by checking MIC and Key Replay Counter Field
    - and if valid sends a confirmation to the AP
